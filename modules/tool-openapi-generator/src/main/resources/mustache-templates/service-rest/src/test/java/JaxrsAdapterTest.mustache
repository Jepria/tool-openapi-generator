package {{apiPackage}};

import {{modelPackage}}.*;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import io.restassured.RestAssured;
import io.restassured.response.Response;
import io.restassured.specification.RequestSpecification;
import org.jepria.server.data.SearchRequestDto;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import javax.ws.rs.core.MediaType;
import java.util.*;
import java.util.stream.IntStream;

public class {{entityName}}JaxrsAdapterTestIT {

  private static final String baseUrl          = ""; // TODO
  private static final String operatorName     = ""; // TODO
  private static final String operatorPassword = ""; // TODO

{{#operations}}
{{#operation}}
  @Test
  public void {{nickname}}() {
    String testUrl = baseUrl + "{{path}}";

    RestAssured.given()
      .auth()
      .basic(operatorName, operatorPassword)
      .when()
      .get(testUrl)
      .then()
      .assertThat()
      .statusCode(200);
 }
{{/operation}}

{{/operations}}
/*************************************************************/
{{#crudOperations}}
  {{#isCreate}}
  @Test
  public void createRecordTest() {
    String testUrl = baseUrl;

    {{entityName}}Dto testDto = new {{entityName}}Dto();
    //TODO: set DTO fields

    RequestSpecification requestPost =
        RestAssured.given().auth().basic(operatorName, operatorPassword)
            .header("Content-Type", "application/json")
            .body(testDto);

    Response postResponse = requestPost.post(testUrl);

    int statusCode = postResponse.statusCode();
    Assert.assertEquals(201, statusCode);
  }
  {{/isCreate}}
  {{#isRead}}
  @Test
  public void getRecordByIdTest() {
    Integer recordId = 1; //TODO: set record ID for test

    String   testUrl  = baseUrl + "/" + recordId;
    Response response = RestAssured.given().auth().basic(operatorName, operatorPassword).when().get(testUrl);
    Assert.assertEquals(testUrl, 200, response.statusCode());
    //TODO: check response DTO
  }
  {{/isRead}}
  {{#isUpdate}}
  @Test
  public void updateRecordTest() {
    Integer recordId = 0; //TODO: set record ID for test

    String testUrl = baseUrl + "/" + recordId;

    {{entityName}}Dto testDto = new {{entityName}}Dto();
    //TODO: set DTO fields

    RequestSpecification requestPost =
        RestAssured.given().auth().basic(operatorName, operatorPassword)
            .header("Content-Type", "application/json")
            .body(testDto);

    Response postResponse = requestPost.post(testUrl);

    int statusCode = postResponse.statusCode();
    Assert.assertEquals(200, statusCode);

    //TODO: check response DTO
  }
  {{/isUpdate}}
  {{#isDelete}}
  @Test
  public void deleteRecordTest() {
    Integer recordId = 0; //TODO: set record ID for test

    String testUrl = baseUrl + "/" + recordId;

    RequestSpecification requestDelete =
        RestAssured.given().auth().basic(operatorName, operatorPassword);

    Response deleteResponse = requestDelete.delete(testUrl);

    int statusCode = deleteResponse.statusCode();
    Assert.assertEquals(200, statusCode); //TODO: maybe should be 204
  }
  {{/isDelete}}
{{/crudOperations}}

/**********************************************/
{{#hasCrud}}
  // CRUD complex test
  private String createRecord({{entityName}}Dto testDto, String location) {
    RequestSpecification requestPost =
        RestAssured.given().auth().basic(operatorName, operatorPassword)
            .header("Content-Type", "application/json")
            .body(testDto);

    Response postResponse = requestPost.post(location);

    int statusCode = postResponse.statusCode();
    Assert.assertEquals(201, statusCode);
    return postResponse.getHeader("Location");
  }

  private void updateRecord({{entityName}}Dto testDto, Integer recordId) {
    updateRecord(testDto, baseUrl + "/" + recordId);
  }

  private void updateRecord({{entityName}}Dto testDto, String location) {
    RequestSpecification requestPost =
        RestAssured.given().auth().basic(operatorName, operatorPassword)
            .header("Content-Type", "application/json")
            .body(testDto);
    Response postResponse = requestPost.put(location);

    int statusCode = postResponse.statusCode();
    Assert.assertEquals(200, statusCode);
  }

  private {{entityName}}Dto getRecord(String location) {
    Response response = RestAssured.given().auth().basic(operatorName, operatorPassword).when().get(location);
    Assert.assertEquals(location, 200, response.statusCode());
    Gson gson = new GsonBuilder().setDateFormat("dd.MM.yyyy").create();
    return gson.fromJson(response.asString(), {{entityName}}Dto.class);
  }

  private {{entityName}}Dto getRecord(Integer recordId) {
    String testUrl = baseUrl + "/" + recordId;
    return getRecord(testUrl);
  }

  private void deleteRecord(int recordId) {
    deleteRecord(baseUrl + "/" + recordId);
  }

  private void deleteRecord(String location) {
    RequestSpecification requestDelete =
        RestAssured.given().auth().basic(operatorName, operatorPassword);

    Response deleteResponse = requestDelete.delete(location);

    int statusCode = deleteResponse.statusCode();
    Assert.assertEquals(200, statusCode); //TODO: maybe should be 204
  }

  @Test
  public void {{entityName}}CrudTest() {
    String testUrl = baseUrl;

    {{entityName}}Dto dto = new {{entityName}}Dto();
    //TODO: set DTO fields
    dto.set{{entityName}}Name("name");
    dto.set{{entityName}}NameEn("name");
    dto.setDescription("TestDescription");

    String location = createRecord(dto, testUrl);

    {{entityName}}Dto createdDto = getRecord(location);
    //TODO: compare dto and createdDto

    {{entityName}}Dto newDto = new {{entityName}}Dto();
    newDto.set{{entityName}}Name("newName");
    newDto.set{{entityName}}NameEn("newName");

    updateRecord(newDto, location);

    {{entityName}}Dto updatedDto = getRecord(location);
    //TODO: compare newDto and updatedDto

    deleteRecord(location);
  }
{{/hasCrud}}
{{#hasSearch}}
  // test search API
  private String postSearchRequest(SearchRequestDto<{{entityName}}SearchDto> searchRequestDto, String location) {

    RequestSpecification request =
        RestAssured.given().auth().basic(operatorName, operatorPassword)
            .header("content-type", MediaType.APPLICATION_JSON + ";charset=utf-8")
            .body(searchRequestDto);

    Response postResponse = request.post(location);
    Assert.assertEquals(201, postResponse.statusCode());

    return postResponse.getHeader("location");
  }

  private SearchRequestDto<{{entityName}}SearchDto> getSearchRequest(String searchLocation) {
    RequestSpecification request =
        RestAssured.given().auth().basic(operatorName, operatorPassword);

    Response response = request.get(searchLocation);
    Assert.assertEquals(200, response.getStatusCode());

    return new Gson().fromJson(response.asString(), SearchRequestDto.class);
  }

  private Integer get{{entityName}}SearchResultSetSize(String location) {
    String testUrl = location + "/resultset-size";

    RequestSpecification request =
        RestAssured.given().auth().basic(operatorName, operatorPassword);

    Response response = request.get(testUrl);
    Assert.assertEquals(200, response.getStatusCode());

    return response.getBody().as(Integer.TYPE);
  }

  private {{entityName}}Dto get{{entityName}}Result(String location) {
    RequestSpecification request =
        RestAssured.given().auth().basic(operatorName, operatorPassword);

    Response response = request.get(location);

    Assert.assertEquals(200, response.statusCode());

    Gson gson = new GsonBuilder().create();
    return gson.fromJson(response.asString(), {{entityName}}Dto.class);
  }

  @Test
  public void {{entityName}}SearchTest() {
    String testUrl = baseUrl + "/search";

    SearchRequestDto<{{entityName}}SearchDto> searchRequestDto = new SearchRequestDto<>();

    {{entityName}}SearchDto searchDto = new {{entityName}}SearchDto();
    searchDto.set{{entityName}}Id(151);
    searchRequestDto.setTemplate(searchDto);

    String searchLocation = postSearchRequest(searchRequestDto, testUrl);

    SearchRequestDto<{{entityName}}SearchDto> readRequest = getSearchRequest(searchLocation);
    //TODO: compare SearchRequestDto-s

    if (get{{entityName}}SearchResultSetSize(searchLocation) > 0) {
      get{{entityName}}Result(searchLocation);
    }

  }
{{/hasSearch}}

}
